# 머니/지갑 도메인 Task

## 1) 개요
- 입력 문서: `./.codex/design/money-wallet-domain.md`
- 목표: 머니 입금/출금/이벤트 기반 지갑 변경을 구현하기 위한 실행 가능한 Task 분해

## 2) Task 목록

- ID: TASK-001
- 제목: 지갑/머니 도메인 데이터 모델 정의
- 목적: 지갑, 입금/출금 신청, 머니 이벤트의 구조와 상태를 명확히 한다.
- 범위: 포함 - 지갑 잔액/예약금 필드, 입금/출금 상태(신청/승인/취소/완료), 이벤트 기록 스키마 / 제외 - 외부 결제 상세
- 의존성: 없음
- 산출물: 테이블/엔티티 정의서, 상태 전이 표
- 검증: 상태 전이가 규칙(완료/취소 이후 수정 불가, 마이너스 허용)을 만족하는지 검토

- ID: TASK-002
- 제목: 머니 이벤트 기록/처리 파이프라인 설계
- 목적: 지갑 변경을 이벤트로 기록하고 순차 처리 구조를 설계한다.
- 범위: 포함 - 이벤트 타입 정의, 이벤트 저장, 소비 순서 보장 / 제외 - 대용량 분산 처리
- 의존성: TASK-001
- 산출물: 이벤트 타입 목록, 처리 흐름 문서
- 검증: 단일 스레드 처리로 DB 락 없이 순차 처리 가능 여부 검토

- ID: TASK-003
- 제목: 단일 스레드 실행기 구성
- 목적: 지갑 변경 이벤트를 단일 스레드로 처리한다.
- 범위: 포함 - 실행기 Bean 구성, 큐잉 방식 / 제외 - 멀티 스레드 확장
- 의존성: TASK-002
- 산출물: 실행기 설정 코드(예: `paymentExecutor`), 운영 가이드
- 검증: 동시 이벤트 발생 시 처리 순서 보장 확인

- ID: TASK-004
- 제목: 지갑 잔액/예약금 업데이트 로직 구현
- 목적: 지갑 변경 규칙(예약 차감, 마이너스 허용, 출금 제한)을 구현한다.
- 범위: 포함 - 잔액/예약금 계산, 마이너스 시 출금 불가 검사 / 제외 - UI 표시 로직
- 의존성: TASK-001, TASK-003
- 산출물: 지갑 서비스/도메인 로직
- 검증: 마이너스 허용/출금 제한 케이스 테스트

- ID: TASK-005
- 제목: 입금 신청/승인/취소 기능 구현
- 목적: 입금 신청부터 승인/취소, 지갑 반영까지 처리한다.
- 범위: 포함 - 신청 생성, 관리자 승인/취소, 승인 후 취소 처리 / 제외 - 관리자 확인 상세 프로세스
- 의존성: TASK-001, TASK-002, TASK-004
- 산출물: 입금 도메인 서비스, 상태 전이, 이벤트 발행
- 검증: 승인 후 취소 시 지갑 차감 및 마이너스 허용 케이스 확인

- ID: TASK-006
- 제목: 출금 신청/승인/취소 기능 구현
- 목적: 출금 신청 시 예약 차감, 승인/취소, 롤백 처리한다.
- 범위: 포함 - 신청 시 예약 차감, 승인 완료, 취소 시 롤백 / 제외 - 외부 지급 프로세스
- 의존성: TASK-001, TASK-002, TASK-004
- 산출물: 출금 도메인 서비스, 상태 전이, 이벤트 발행
- 검증: 취소 후 롤백 및 완료/취소 이후 수정 불가 확인

- ID: TASK-007
- 제목: 관리자 승인/취소 처리 정책 구현
- 목적: 승인/취소 조건과 불가 케이스를 중앙화한다.
- 범위: 포함 - 상태 검증, 취소 후 재신청 안내 트리거 / 제외 - 메시지 템플릿
- 의존성: TASK-005, TASK-006
- 산출물: 승인/취소 정책 모듈
- 검증: 완료/취소 이후 수정 차단 검증

- ID: TASK-008
- 제목: 머니 변경 이벤트 기록 및 지갑 반영 연결
- 목적: 입금/출금 처리 시 이벤트 기록과 지갑 반영을 일관되게 연결한다.
- 범위: 포함 - 이벤트 생성/저장, 소비 핸들러 / 제외 - 이벤트 재처리 도구
- 의존성: TASK-002, TASK-003, TASK-004, TASK-005, TASK-006
- 산출물: 이벤트 발행/소비 코드
- 검증: 이벤트 기반 지갑 반영 순서와 정합성 테스트

- ID: TASK-009
- 제목: 비기능 요구 검증 시나리오 작성
- 목적: DB 락 금지, 단일 스레드 순차 처리, 마이너스 출금 제한을 검증한다.
- 범위: 포함 - 동시성/순차성/락 회피 테스트 시나리오 / 제외 - 성능 부하 테스트
- 의존성: TASK-003, TASK-008
- 산출물: 테스트 시나리오/체크리스트
- 검증: 시나리오 기반 검토 및 결과 기록

## 3) 의존성 맵(간단)
- TASK-001 -> TASK-002 -> TASK-003
- TASK-001 + TASK-003 -> TASK-004
- TASK-004 + TASK-002 -> TASK-005, TASK-006
- TASK-005 + TASK-006 -> TASK-007
- TASK-002/003/004/005/006 -> TASK-008
- TASK-003/008 -> TASK-009

## 4) 오픈 질문/리스크
- 머니 사용(서비스 이용/베팅 참여/정산)의 상세 규칙과 정책 정의 필요
- 이벤트/베팅 적립 규칙 및 승인 필요 여부 확정 필요
- 지갑 잔액 필드(총액/가용/예약) 최종 정의 필요
- 관리자 승인 기준 및 감사/로그 정책 필요

## 5) 추가 결정사항(대화 반영)
- 도메인 분리: 입출금 신청은 `zod.payment`, 지갑 상태/머니 변경 히스토리는 `zod.wallet`
- 지갑 상태: `money`, `point` 총액만 보관
- 예약 금액: 별도 예약 필드 없이 출금 신청 시 `money` 즉시 차감
- 출금 취소: 머니 이벤트를 발행해 롤백(재적립) 처리
- 상태 enum(입금/출금 공통): 동사형 `REQUEST`, `APPROVE`, `CANCEL`, `ROLLBACK`
- 머니 변경 처리: 이벤트 기반 단일 스레드 순차 처리(예: 풀 사이즈 1 실행기)
- 머니 이벤트 필드: `userid`, `type(MoneyCode)`, `amount`, `beforeBalance`, `refId`, `createdAt`
- 포인트 이벤트 필드: `userid`, `type(PointCode)`, `amount`, `beforeBalance`, `refId`, `createdAt`
- 금액 타입: `value class Money(Long)`, `value class Point(Long)`
- 입금/출금 통합 엔티티: `Banking`
- 처리자 필드: `processedBy`
