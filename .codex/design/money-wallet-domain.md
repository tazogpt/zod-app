# 머니/지갑 도메인 정리

## 1) 도메인 개요
- 목적/문제: 사이트 서비스 이용에 쓰이는 머니를 입금/출금으로 적립·차감하고, 이벤트/베팅 적중 등으로 적립하는 흐름을 관리
- 대상 사용자(액터): 일반 고객, 관리자/운영자
- 범위/경계: 웹/모바일/백오피스 포함, 머니는 사이트 내 사용 전용, 마이너스 잔액 가능하나 마이너스일 때 출금 불가

## 2) 핵심 개념/엔티티
- 지갑: 현재 보유 머니를 기록하는 저장소(잔액/가용잔액/예약금 등)
- 입금: 사용자의 입금 신청을 관리자가 승인/거절하는 프로세스
- 출금: 지갑 한도 내 신청 후 관리자가 승인/거절하는 프로세스

주요 관계
- 지갑은 입금/출금 승인/취소 결과에 따라 변경된다.
- 머니 변경은 이벤트로 기록되고 단일 스레드로 순차 처리된다.

## 3) 유저케이스

- UC1. 입금 신청 승인/취소 (Primary)
  - 목표: 입금 신청에 대해 승인/취소 처리 후 지갑을 갱신
  - 정상 흐름: 입금 신청 -> 관리자 알람 -> 승인/취소 -> 승인 시 지갑 업데이트, 취소 시 신청 취소 처리
  - 예외/규칙:
    - 승인 후에도 취소 가능
    - 승인 취소 시 지갑에서 머니 제거
    - 승인 후 사용으로 인해 취소 시 잔액 마이너스 가능 (허용)
    - 잔액 마이너스 시 출금 불가

- UC2. 출금 신청 승인/취소 (Primary)
  - 목표: 출금 신청에 대해 승인/취소 처리 및 지갑 롤백
  - 정상 흐름: 출금 신청 -> 신청 금액을 지갑에서 차감(예약) -> 관리자 승인/취소 -> 승인 시 완료 처리, 취소 시 신청 취소 및 지갑 롤백
  - 예외/규칙:
    - 완료/취소 이후 수정 불가
    - 취소 시 사용자에게 재신청 안내
    - 완료 후 취소가 필요하면 별도 프로세스로 사용자 지갑 보정

- UC3. 지갑 변경 이벤트 처리 (Primary)
  - 목표: 지갑 변경을 이벤트로 기록하고 순차 처리
  - 정상 흐름: 머니 변경 이벤트 기록 -> 단일 스레드 실행기로 순차 처리 -> 지갑 업데이트
  - 예외/규칙:
    - DB 락 발생 금지

## 4) 기능 정의
- 입금 신청/승인/취소
- 출금 신청/승인/취소
- 지갑 잔액/예약금 변경 및 검증(마이너스 허용 여부, 출금 제한)
- 머니 변경 이벤트 기록
- 단일 스레드 이벤트 처리

유저케이스 매핑
- UC1 -> 입금 신청/승인/취소, 지갑 변경, 이벤트 기록
- UC2 -> 출금 신청/승인/취소, 지갑 변경/롤백, 이벤트 기록
- UC3 -> 이벤트 기록, 단일 스레드 처리, 지갑 업데이트

우선순위(MVP/후속)
- MVP: UC1, UC2, UC3 전부 포함

## 5) 규칙/제약/비기능 요구
- 출금 신청 시 지갑에서 즉시 차감(예약)하여 다른 사용 차단
- 잔액 마이너스 허용, 마이너스 시 출금 불가
- 지갑 변경은 이벤트 기반 순차 처리
- 단일 스레드 실행기 사용(예: `@Bean("paymentExecutor")` 풀 사이즈 1)
- DB 락 발생 금지

## 6) 오픈 질문/가정
- 머니 사용(서비스 이용/베팅 참여/정산)의 상세 규칙과 정책
- 이벤트/베팅 적중 적립 규칙 및 승인 필요 여부
- 지갑 잔액의 필드 구성(총액/가용/예약 등)
- 관리자 승인 기준과 로그/감사 요구사항
